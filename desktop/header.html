<div class="create-topic-visibility"></div>

<script type="text/discourse-plugin" version="0.8">

function getVaperinaPanel() {
  let pref = localStorage.getItem("vaperinaPanel");
  let result = settings.vaperina_panel;
  if (pref !== null || pref === null) {
    result = pref === "true";
  }
  return result;
}

if (getVaperinaPanel()) {
  
  if (!"IntersectionObserver" in window) return;

  const { on } = require("discourse-common/utils/decorators");
  
  const stickyClass = "sticky-create-topic";

  api.modifyClass("component:create-topic-button", {
    pluginId: "sticky-create-topic",
    @on("didInsertElement")
    stickyHeaderCheck() {
      const anchor = document.querySelector(".create-topic-visibility");
      const body = document.querySelector("body");
      const homePage = document.querySelector('.navigation-topics');
      const categoryPage = document.querySelector('body[class*="category-"]:not(.archetype-regular):not(.archetype-banner)');
      const tagPage = document.querySelector('.tags-page');

      new IntersectionObserver(entries => {
        if (!entries[0].isIntersecting) {
          body.classList.add(stickyClass);
        } else {
          if (!homePage || !categoryPage || !tagPage) {
            body.classList.remove(stickyClass);
          }
        }
      }).observe(anchor);
    }
  });
}
</script>
